#!/bin/bash
# Pre-push hook: ALL CI checks MUST pass before pushing
# This ensures code quality and prevents broken builds

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "============================================="
echo "Running pre-push CI checks (ALL MANDATORY)..."
echo "============================================="

# 1. Format check
echo -e "\n${YELLOW}[1/4] Checking formatting...${NC}"
if ! cargo fmt --all -- --check; then
    echo -e "${RED}ERROR: Code is not formatted.${NC}"
    echo "Run 'cargo fmt' before pushing."
    exit 1
fi
echo -e "${GREEN}✓ Formatting OK${NC}"

# 2. Cargo check (compilation)
echo -e "\n${YELLOW}[2/4] Running cargo check...${NC}"
if ! cargo check --workspace; then
    echo -e "${RED}ERROR: Compilation failed.${NC}"
    echo "Fix compilation errors before pushing."
    exit 1
fi
echo -e "${GREEN}✓ Compilation OK${NC}"

# 3. Clippy (linting) - MANDATORY
# Check main code (not tests) with strict warnings
echo -e "\n${YELLOW}[3/4] Running clippy...${NC}"
if ! cargo clippy --workspace -- \
    -D warnings \
    -A clippy::too_many_arguments \
    -A clippy::large_enum_variant \
    -A clippy::type_complexity \
    -A clippy::await_holding_lock \
    -A clippy::collapsible_match \
    -A clippy::collapsible_if \
    -A clippy::needless_borrows_for_generic_args \
    -A clippy::to_string_in_format_args \
    -A clippy::manual_map \
    -A clippy::map_flatten \
    -A clippy::useless_format \
    -A clippy::redundant_closure \
    -A deprecated \
    -A dead_code \
    -A clippy::for_kv_map \
    -A clippy::to_string_trait_impl \
    -A clippy::if_same_then_else \
    -A unused_variables \
    -A unused_imports \
    -A clippy::useless_conversion \
    -A for_loops_over_fallibles \
    -A clippy::manual_filter_map \
    -A clippy::collapsible_str_replace \
    -A clippy::manual_is_multiple_of \
    -A clippy::map_entry \
    -A clippy::manual_flatten; then
    echo -e "${RED}ERROR: Clippy found issues.${NC}"
    echo "Fix clippy warnings before pushing."
    exit 1
fi
echo -e "${GREEN}✓ Clippy OK${NC}"

# 4. Tests - MANDATORY
echo -e "\n${YELLOW}[4/4] Running tests...${NC}"
if ! cargo test --workspace; then
    echo -e "${RED}ERROR: Tests failed.${NC}"
    echo "Fix failing tests before pushing."
    exit 1
fi
echo -e "${GREEN}✓ Tests OK${NC}"

echo -e "\n${GREEN}============================================="
echo "All CI checks passed! Pushing..."
echo -e "=============================================${NC}"
